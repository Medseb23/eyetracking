<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diagn√≥stico Boca + Mirada + Brocha (getUserMedia)</title>

<!-- WebGazer (mirada) -->
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

<!-- MediaPipe FaceMesh (boca) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>

<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#0f1115; color:#fff; }
  #wrap { position:relative; width:100%; height:100vh; }

  #topbar { position:absolute; top:10px; left:10px; right:10px; display:flex; gap:8px; flex-wrap:wrap;
            background:rgba(0,0,0,.45); padding:8px 10px; border-radius:10px; align-items:center;
            z-index:10000; }
  .btn { appearance:none; border:0; padding:6px 10px; border-radius:10px; cursor:pointer;
         background:#22272e; color:#fff; font-weight:600; }
  .btn.primary { background:#00e676; color:#111; }
  .btn.warn { background:#ff5252; }
  .sp { margin-left:auto; font:12px/1.2 monospace; opacity:.9; }

  #stage { position:absolute; inset:62px 10px 10px 10px; border-radius:10px; background:#10131a; overflow:hidden; }
  #canvas { position:absolute; inset:0; width:100%; height:100%; }
  #cursor { position:absolute; width:20px; height:20px; border:2px solid rgba(255,255,255,.95); border-radius:50%;
            pointer-events:none; transform:translate(-50%,-50%); display:none; }

  #status { position:absolute; bottom:10px; left:10px; right:10px; display:flex; gap:10px; align-items:center;
            background:rgba(255,255,255,.06); padding:8px 10px; border-radius:10px; z-index:9999; }
  #modeTag { font-weight:700; background:#1f2937; padding:4px 8px; border-radius:8px; }
  #marPanel{ display:flex; align-items:center; gap:8px; flex:1; }
  #marBar{ position:relative; height:10px; flex:1; background:#2b2f3a; border-radius:6px; overflow:hidden; }
  #marFill{ position:absolute; top:0; left:0; height:100%; width:0%; background:#00e676; }
  #marThr{ position:absolute; top:-3px; width:2px; height:16px; background:#ff5252; left:50%; }
  #marVal { min-width:72px; text-align:right; font:12px/1 monospace; opacity:.9; }

  #preview { position:absolute; top:10px; right:10px; width:300px; height:225px; background:#000a; border-radius:8px; display:none; z-index:5000; }
  video#rawVideo { display:none; }

  #errbar { position:absolute; bottom:0; left:0; right:0; background:#ff3344; color:#100;
            padding:6px 10px; font:12px/1.3 monospace; display:none; z-index:10001; }
</style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <button id="testCam" class="btn">üé• Probar c√°mara (getUserMedia)</button>
    <button id="modeFace" class="btn">1) Test de Boca</button>
    <button id="modeGaze" class="btn">2) Test de Mirada</button>
    <button id="modeBrush" class="btn primary">3) Iniciar Brocha</button>
    <button id="calGaze" class="btn">üéØ Calibrar mirada</button>
    <button id="calMouth" class="btn">üëÑ Calibrar boca</button>
    <button id="togglePreview" class="btn">üëÅÔ∏è Preview</button>
    <button id="clear" class="btn warn">üßπ Limpiar</button>
    <button id="savePng" class="btn">üñºÔ∏è PNG</button>
    <button id="saveCsv" class="btn">üìÑ CSV</button>
    <span class="sp" id="count">pts: 0</span>
  </div>

  <div id="stage">
    <canvas id="canvas"></canvas>
    <div id="cursor"></div>
    <canvas id="preview"></canvas>
    <video id="rawVideo" playsinline autoplay muted></video>
  </div>

  <div id="status">
    <span id="modeTag">Modo: ‚Äî</span>
    <div id="marPanel">
      <span>MAR:</span>
      <div id="marBar"><div id="marFill"></div><div id="marThr"></div></div>
      <span id="marVal">‚Äî</span>
    </div>
  </div>

  <div id="errbar"></div>
</div>

<script>
(function(){
  const errbar = document.getElementById('errbar');
  function showErr(msg){ errbar.textContent = '‚ö†Ô∏è ' + msg; errbar.style.display='block'; }
  window.onerror = (m, src, line, col, err) => { showErr((m||'Error') + (line?` @${line}:${col||0}`:'')); };
  window.onunhandledrejection = (e) => { showErr('Promise rejection: ' + (e.reason?.message || e.reason || '')); };

  const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
  const cursor = document.getElementById('cursor');
  const preview = document.getElementById('preview'); const pctx = preview.getContext('2d');
  const rawVideo = document.getElementById('rawVideo');

  // ======== getUserMedia manual =========
  let gStream=null;
  async function startCamera(){
    try{
      gStream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
      rawVideo.srcObject = gStream;
      await rawVideo.play();
      errbar.style.display='none';
      alert('‚úÖ C√°mara iniciada.');
    }catch(e){
      showErr('getUserMedia: '+ (e.name||'') + ' ‚Äî ' + (e.message||''));
    }
  }
  document.getElementById('testCam').addEventListener('click', startCamera);

  // ======== FaceMesh ========
  const faceMesh = new FaceMesh({
    locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
  });
  faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:.5, minTrackingConfidence:.5 });

  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  let mar=0;

  async function faceLoop(){
    try{
      if (rawVideo.readyState >= 2 && !rawVideo.paused && !rawVideo.ended){
        await faceMesh.send({ image: rawVideo });
      }
    }catch(e){ showErr('faceLoop: '+e.message); }
    requestAnimationFrame(faceLoop);
  }
  faceMesh.onResults(res=>{
    if(!res.multiFaceLandmarks || !res.multiFaceLandmarks.length) return;
    const lm = res.multiFaceLandmarks[0];
    const top=lm[13], bottom=lm[14], left=lm[78], right=lm[308];
    mar = dist(top,bottom)/Math.max(1e-6, dist(left,right));
    document.getElementById('marVal').textContent = mar.toFixed(3);
  });

  // ======== WebGazer ========
  webgazer.setRegression('ridge').setTracker('TFFacemesh').begin()
    .showVideoPreview(false).showPredictionPoints(false).showFaceFeedbackBox(false);

  webgazer.setGazeListener((data)=>{
    if(data){ cursor.style.display='block'; cursor.style.left=data.x+'px'; cursor.style.top=data.y+'px'; }
  });

  requestAnimationFrame(faceLoop);
})();
</script>
</body>
</html>
